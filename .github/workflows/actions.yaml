name: Github CI
on:
  push:

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      weeks: ${{ steps.detect.outputs.weeks_json }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0   # full history for git diff

      - name: Show workspace
        run: echo "GITHUB WORKSPACE: $GITHUB_WORKSPACE"

      - id: detect
        name: Detect changed weeks
        run: |
          set -euo pipefail

          if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            base=$(git hash-object -t tree /dev/null)
            changed=$(git diff --name-only "$base" "${{ github.sha }}" \
              | grep -E '^week[0-9]+/' \
              | cut -d/ -f1 | sort -u || true)
          else
            changed=$(git diff --name-only "${{ github.event.before }}" "${{ github.sha }}" \
              | grep -E '^week[0-9]+/' \
              | cut -d/ -f1 | sort -u || true)
          fi

          if [ -n "$changed" ]; then
            weeks_json=$(printf '%s\n' "$changed" | jq -R . | jq -s .)
          else
            weeks_json="[]"
          fi

          echo "weeks_json=$weeks_json" >> $GITHUB_OUTPUT
          echo "Detected weeks: $weeks_json"

  evaluate:
    needs: detect
    if: ${{ needs.detect.outputs.weeks != '[]' }}   # skip if no weeks changed
    runs-on: ubuntu-latest
    strategy:
      matrix:
        week: ${{ fromJSON(needs.detect.outputs.weeks) }}
    name: Evaluate ${{ matrix.week }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install Codon
        run: |
          mkdir -p ${HOME}/.codon
          curl -L https://github.com/exaloop/codon/releases/download/v0.19.3/codon-linux-x86_64.tar.gz \
            | tar zxvf - --strip-components=1 -C ${HOME}/.codon
          curl -L https://github.com/exaloop/seq/releases/download/v0.11.5/seq-linux-x86_64.tar.gz \
            | tar zxvf - -C ${HOME}/.codon/lib/codon/plugins
          echo "${HOME}/.codon/bin" >> $GITHUB_PATH

      - name: Setup Python Interpreter
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Set up Codon Python bridge
        run: |
          export CODON_PYTHON=$(curl -L https://raw.githubusercontent.com/exaloop/codon/refs/heads/develop/test/python/find-python-library.py | python)
          echo "Found Python at: ${CODON_PYTHON}"

      - name: Run evaluation
        run: |
          echo "Running evaluation for ${{ matrix.week }}..."
          python "${{ matrix.week }}/evaluate.py"

      - name: Append report to job summary (if present)
        run: |
          if [ -f "${{ matrix.week }}/report.md" ]; then
            echo "## Report for ${{ matrix.week }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            cat "${{ matrix.week }}/report.md" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ No report.md found for ${{ matrix.week }}" >> $GITHUB_STEP_SUMMARY
          fi
